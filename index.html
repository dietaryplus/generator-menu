
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Menús Redox - Dietaryplus</title>
    <meta name="description" content="Crea planes nutricionales personalizados basados en la Filosofía Redox de Dietaryplus">
    <meta name="keywords" content="nutrición, redox, dietaryplus, menús, salud, estreñimiento, SOP">
    <meta name="author" content="Dietaryplus">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌱</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .form-section {
            display: block;
        }
        
        .preview-section {
            display: none;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .form-group input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .radio-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .radio-option:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .radio-option input[type="radio"] {
    margin-right: 10px;
    transform: scale(1.2);
}
        
        .radio-option input[type="radio"]:checked + .option-content {
            color: #2980b9;
            font-weight: 600;
        }
        
        .radio-option input[type="radio"]:checked ~ .option-icon {
            background: #3498db;
            color: white;
        }
        
        .option-content h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .option-content p {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .option-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            transition: all 0.3s;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-option {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checkbox-option:hover {
            background: #e3f2fd;
            border-color: #3498db;
        }
        
        .checkbox-option input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .checkbox-option input[type="checkbox"]:checked + span {
            color: #2980b9;
            font-weight: 600;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-right: 10px;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .actions {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e9ecef;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .preview-menu {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .preview-menu h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .menu-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .menu-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .menu-table td {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85em;
            vertical-align: top;
        }
        
        .menu-table .meal-label {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            width: 120px;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            text-align: center;
        }
        
        .footer {
            background: #f8f9fa;
            color: #6c757d;
            text-align: center;
            padding: 20px;
            border-top: 1px solid #e9ecef;
            font-size: 0.9em;
        }
        
        .duration-selector {
            display: none;
        }
        
        .phase-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .phase-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .phase-number {
            background: #3498db;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .phase-title {
            flex: 1;
        }
        
        .phase-title h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        
        .phase-title p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .week-menu {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .week-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .radio-group {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌱 Generador de Menús Redox</h1>
            <p>Crea planes nutricionales personalizados basados en la Filosofía Redox</p>
        </div>
        
        <div class="main-content">
            <!-- FORMULARIO -->
            <div class="form-section" id="formSection">
                <div class="form-group">
                    <label for="patientName">👤 Nombre del Paciente</label>
                    <input type="text" id="patientName" placeholder="Ej: María García" required>
                </div>
                
                <div class="form-group">
                    <label>🎯 Condición Principal (la más urgente a tratar)</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="constipation" name="condition" value="estreñimiento">
                            <div class="option-content">
                                <h3>Estreñimiento Severo</h3>
                                <p>0-2 deposiciones/semana, distensión, dolor abdominal</p>
                            </div>
                            <div class="option-icon">💧</div>
                        </div>
                        
                        <div class="radio-option">
                            <input type="radio" id="pcos" name="condition" value="sop">
                            <div class="option-content">
                                <h3>SOP (Síndrome Ovario Poliquístico)</h3>
                                <p>Resistencia insulínica, hiperandrogenismo, disbiosis</p>
                            </div>
                            <div class="option-icon">⚖️</div>
                        </div>
                        
                        <div class="radio-option">
                            <input type="radio" id="weightloss" name="condition" value="perdida-peso">
                            <div class="option-content">
                                <h3>Pérdida de Peso</h3>
                                <p>Reducción de volumen sin efecto rebote</p>
                            </div>
                            <div class="option-icon">📉</div>
                        </div>
                        
                        <div class="radio-option">
                            <input type="radio" id="inflammation" name="condition" value="inflamacion">
                            <div class="option-content">
                                <h3>Inflamación Sistémica</h3>
                                <p>Artritis, fatiga, dolor crónico, marcadores elevados</p>
                            </div>
                            <div class="option-icon">🔥</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>📅 Tipo de Plan</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="plan-semanal" name="planType" value="semanal">
                            <div class="option-content">
                                <h3>Plan Semanal</h3>
                                <p>1 menú para empezar inmediatamente</p>
                            </div>
                            <div class="option-icon">📋</div>
                        </div>
                        
                        <div class="radio-option">
                            <input type="radio" id="plan-evolutivo" name="planType" value="evolutivo">
                            <div class="option-content">
                                <h3>Plan Evolutivo Estratégico</h3>
                                <p>Múltiples menús con visión a largo plazo</p>
                            </div>
                            <div class="option-icon">🔄</div>
                        </div>
                    </div>
                </div>

                <div class="form-group duration-selector" id="durationSelector">
                    <label>⏱️ Duración del Tratamiento</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="duration-4" name="duration" value="4">
                            <div class="option-content">
                                <h3>4 Semanas - Choque Intensivo</h3>
                                <p>Para problemas agudos. Máxima intensidad, resultados rápidos.</p>
                            </div>
                            <div class="option-icon">⚡</div>
                        </div>
                        
                        <div class="radio-option">
                            <input type="radio" id="duration-8" name="duration" value="8">
                            <div class="option-content">
                                <h3>8 Semanas - Tratamiento Completo</h3>
                                <p>Choque + estabilización + optimización. Más popular.</p>
                            </div>
                            <div class="option-icon">🎯</div>
                        </div>
                        
                        <div class="radio-option">
                            <input type="radio" id="duration-12" name="duration" value="12">
                            <div class="option-content">
                                <h3>12 Semanas - Transformación Profunda</h3>
                                <p>Para casos complejos. Abordaje integral y sostenible.</p>
                            </div>
                            <div class="option-icon">🌟</div>
                        </div>
                        
                        <div class="radio-option">
                            <input type="radio" id="duration-16" name="duration" value="16">
                            <div class="option-content">
                                <h3>16 Semanas - Regeneración Total</h3>
                                <p>Para casos severos. Nueva versión de ti mismo.</p>
                            </div>
                            <div class="option-icon">🚀</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>➕ Condiciones Secundarias (que también quiere mejorar)</label>
                    <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">Selecciona todas las que apliquen. El menú se adaptará para abordar múltiples problemas.</p>
                    <div class="checkbox-group">
                        <div class="checkbox-option">
                            <input type="checkbox" id="secondary-digestive" value="problemas-digestivos">
                            <span>Problemas Digestivos</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="secondary-fatigue" value="fatiga-cronica">
                            <span>Fatiga Crónica</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="secondary-sleep" value="problemas-sueño">
                            <span>Problemas de Sueño</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="secondary-anxiety" value="ansiedad-estres">
                            <span>Ansiedad / Estrés</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="secondary-skin" value="problemas-piel">
                            <span>Problemas de Piel</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="secondary-hair" value="caida-cabello">
                            <span>Caída del Cabello</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>⚕️ Terapias Físicas Redox</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option">
                            <input type="checkbox" id="infrared" value="infrarrojo">
                            <span>Terapia Infrarrojo</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="thermogenesis" value="termogenesis">
                            <span>Termogénesis</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="vagal" value="vagal">
                            <span>Estimulación Vagal</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>🚫 Exclusiones Alimentarias</label>
                    <div class="checkbox-group">
                        <div class="checkbox-option">
                            <input type="checkbox" id="gluten-free" value="sin-gluten">
                            <span>Sin Gluten</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="dairy-free" value="sin-lacteos">
                            <span>Sin Lácteos</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="nuts-free" value="sin-frutos-secos">
                            <span>Sin Frutos Secos</span>
                        </div>
                        
                        <div class="checkbox-option">
                            <input type="checkbox" id="eggs-free" value="sin-huevos">
                            <span>Sin Huevos</span>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn" onclick="generateMenu()">
                        🚀 Generar Plan Redox
                    </button>
                </div>
            </div>
            
            <!-- LOADING -->
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <h3>Generando tu plan personalizado...</h3>
                <p>Aplicando principios de la Filosofía Redox</p>
            </div>
            
            <!-- PREVIEW -->
            <div class="preview-section" id="previewSection">
                <div class="success-message">
                    ✅ <strong>Plan generado exitosamente!</strong> Revisa el contenido antes de descargar.
                </div>
                
                <div class="preview-menu" id="menuPreview">
                    <!-- El menú se generará aquí dinámicamente -->
                </div>
                
                <div class="actions">
                    <button class="btn btn-secondary" onclick="goBack()">
                        ← Volver al Formulario
                    </button>
                    <button class="btn" onclick="downloadPDF()">
                        📄 Descargar PDF
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>© 2024 Dietaryplus - Generador de Menús Redox | <strong>Versión 2.0 Completa</strong></p>
        </div>
    </div>

    <script>
        // Base de datos Redox expandida
        const baseDatosRedox = {
            estreñimiento: {
                nombre: "Protocolo Anti-Estreñimiento",
                protocolo: "Hidratación intensiva + MCT + Infrarrojo + Estimulación vagal",
                horarios: ["7:00", "7:30", "10:30", "13:30", "16:30", "20:00"],
                momentos: ["DESPERTAR", "DESAYUNO", "ALMUERZO", "COMIDA", "MERIENDA", "CENA"],
                alimentos: {
                    despertar: [
                        "500ml agua tibia + limón + sal marina + 2 cda MCT",
                        "Protocolo hidratación base + aceites específicos",
                        "Activación matinal + estimulación biliar"
                    ],
                    desayunos: [
                        "Batido plátano + nueces + cacao + leche coco + aguacate + mantequilla pasto",
                        "Tortilla 3 huevos pastoreo + espinacas + aguacate + mantequilla pasto generosa",
                        "Revuelto 2 huevos + champiñones + aguacate + semillas calabaza + mantequilla",
                        "Batido verde: espinacas + aguacate + leche coco + huevos pochados + mantequilla"
                    ],
                    almuerzos: [
                        "6-8 ciruelas pasas remojadas overnight + 500ml agua pura",
                        "Compota manzana casera + canela + 500ml agua",
                        "Plátano maduro + nueces crudas + hidratación abundante",
                        "Papaya fresca (enzimas digestivas) + hidratación constante"
                    ],
                    comidas: [
                        "Ensalada variada + AOVE + Puré coco-zanahoria-cebolla + Salmón plancha + Chocolate 85%",
                        "Ensalada + chucrut casero + Puré calabacín-coco + Caballa horno + Chocolate + ciruelas",
                        "Ensalada + kimchi + Puré calabaza-coco + Ternera plancha + Chocolate + frutos rojos",
                        "Ensalada completa + Puré zanahoria-coco + Sardinas frescas + Chocolate + ciruelas"
                    ],
                    meriendas: [
                        "Kéfir cabra 200ml + 1 cda aceite coco + almendras crudas 20g",
                        "Kéfir + aceite coco + nueces 20g",
                        "Kéfir + aceite coco + mix frutos secos naturales"
                    ],
                    cenas: [
                        "Caldo huesos + tuétano + Boniato horno + mantequilla + Pechuga pavo + Infusión sen 22h",
                        "Caldo graso + Calabaza asada + mantequilla + Merluza vapor + Infusión + aceite coco 22h",
                        "Caldo nutritivo + Boniato + mantequilla + Pollo ecológico + Infusión sen + coco 22h"
                    ]
                }
            },
            sop: {
                nombre: "Protocolo SOP - Regulación Hormonal",
                protocolo: "Anti-inflamatorio + Proteína alta + Regulación insulínica + Modulación andrógenos",
                horarios: ["7:00", "11:00", "15:00", "20:00"],
                momentos: ["DESPERTAR", "DESAYUNO", "COMIDA", "CENA"],
                alimentos: {
                    despertar: [
                        "Agua tibia + limón + sal marina + electrolitos",
                        "Base hormonal: hidratación + minerales",
                        "Activación SOP: agua + citrato natural"
                    ],
                    desayunos: [
                        "Huevos pastoreo (2-3) + aguacate grande + mantequilla pasto + aceite oliva",
                        "Salmón ahumado + aguacate + huevos + semillas calabaza + AOVE",
                        "Tortilla proteica + vegetales + grasas antiinflamatorias + mantequilla",
                        "Revuelto alto en proteína + aguacate + aceite coco + frutos secos"
                    ],
                    comidas: [
                        "Ensalada abundante + Crucíferas al vapor + Pescado graso + AOVE abundante",
                        "Ensalada + Fermentados naturales + Carne pastoreo + Grasas calidad",
                        "Ensalada + Vegetales anti-androgénicos + Proteína alta + Aceite oliva",
                        "Ensalada + Probióticos naturales + Proteína completa + AOVE"
                    ],
                    cenas: [
                        "Proteína ligera + Verduras vapor + AOVE + Infusión relajante",
                        "Pescado blanco + Ensalada + Aguacate + Infusión hormonal",
                        "Caldo huesos + Verduras + Proteína ligera + Infusión equilibrante"
                    ]
                }
            },
            'perdida-peso': {
                nombre: "Protocolo Pérdida de Peso",
                protocolo: "Ayuno intermitente + Termogénesis + Cetosis nutricional + Activación metabólica",
                horarios: ["7:00", "12:00", "18:00"],
                momentos: ["DESPERTAR", "COMIDA", "CENA"],
                alimentos: {
                    despertar: [
                        "Agua + limón + sal + MCT (termogénico)",
                        "Café + aceite coco + mantequilla (cetogénico)",
                        "Té verde + aceite MCT (lipolítico)"
                    ],
                    comidas: [
                        "Ensalada + Proteína alta + Grasas termogénicas + Vegetales",
                        "Verduras + Pescado + AOVE + Aguacate + Frutos secos",
                        "Proteína completa + Vegetales + Grasas específicas + Especias"
                    ],
                    cenas: [
                        "Proteína ligera + Verduras + Grasas + Infusión",
                        "Pescado + Ensalada + Aceite oliva + Té",
                        "Caldo + Vegetales + Proteína + Hierbas"
                    ]
                }
            },
            inflamacion: {
                nombre: "Protocolo Anti-Inflamatorio",
                protocolo: "Modulación inmune + Omega-3 + Antioxidantes + Eliminación pro-inflamatorios",
                horarios: ["7:00", "8:00", "13:00", "16:00", "20:00"],
                momentos: ["DESPERTAR", "DESAYUNO", "COMIDA", "MERIENDA", "CENA"],
                alimentos: {
                    despertar: [
                        "Agua + limón + cúrcuma + jengibre",
                        "Hidratación + especias anti-inflamatorias",
                        "Base alcalina + moduladores naturales"
                    ],
                    desayunos: [
                        "Batido antioxidante + omega-3 + frutos rojos",
                        "Huevos + aguacate + cúrcuma + aceite oliva",
                        "Smoothie verde + semillas + grasas anti-inflamatorias"
                    ],
                    comidas: [
                        "Ensalada + Pescado azul + AOVE + Vegetales colores",
                        "Verduras + Salmón + Especias + Frutos secos",
                        "Crucíferas + Proteína + Cúrcuma + Jengibre + AOVE"
                    ],
                    meriendas: [
                        "Frutos rojos + nueces + té verde",
                        "Chocolate 85% + almendras + infusión",
                        "Aguacate + semillas + especias"
                    ],
                    cenas: [
                        "Caldo huesos + vegetales + cúrcuma + proteína ligera",
                        "Pescado + ensalada + jengibre + aceite oliva",
                        "Verduras + proteína + especias + infusión anti-inflamatoria"
                    ]
                }
            }
        };

        let menuGenerado = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('constipation').checked = true;
            document.getElementById('plan-semanal').checked = true;
            document.getElementById('infrared').checked = true;
            
            // Manejar tipo de plan
            document.querySelectorAll('input[name="planType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const durationSelector = document.getElementById('durationSelector');
                    if (this.value === 'evolutivo') {
                        durationSelector.style.display = 'block';
                        document.getElementById('duration-8').checked = true;
                    } else {
                        durationSelector.style.display = 'none';
                    }
                });
            });
        });

        function generateMenu() {
            const patientName = document.getElementById('patientName').value.trim();
            const condition = document.querySelector('input[name="condition"]:checked');
            const planType = document.querySelector('input[name="planType"]:checked');
            
            if (!patientName || !condition || !planType) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }

            if (planType.value === 'evolutivo') {
                const duration = document.querySelector('input[name="duration"]:checked');
                if (!duration) {
                    alert('Por favor, selecciona la duración del tratamiento');
                    return;
                }
            }

            // Mostrar loading
            document.getElementById('formSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';

            setTimeout(() => {
                const data = {
                    condition: condition.value,
                    patientName: patientName,
                    planType: planType.value,
                    duration: planType.value === 'evolutivo' ? document.querySelector('input[name="duration"]:checked').value : null,
                    therapies: getSelectedItems('checkbox', ['infrarrojo', 'termogenesis', 'vagal']),
                    exclusions: getSelectedItems('checkbox', ['sin-gluten', 'sin-lacteos', 'sin-frutos-secos', 'sin-huevos']),
                    secondaryConditions: getSelectedItems('checkbox', ['problemas-digestivos', 'fatiga-cronica', 'problemas-sueño', 'ansiedad-estres', 'problemas-piel', 'caida-cabello'])
                };

                if (data.planType === 'semanal') {
                    menuGenerado = createWeeklyPlan(data);
                } else {
                    menuGenerado = createEvolutionaryPlan(data);
                }
                
                displayPlan(menuGenerado);
                
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('previewSection').style.display = 'block';
            }, 2500);
        }

        function getSelectedItems(type, validValues) {
            const selected = [];
            document.querySelectorAll(`input[type="${type}"]:checked`).forEach(item => {
                if (validValues.includes(item.value)) {
                    selected.push(item.value);
                }
            });
            return selected;
        }

        function createWeeklyPlan(data) {
            const conditionData = baseDatosRedox[data.condition];
            return {
                tipo: 'semanal',
                paciente: data.patientName,
                condicion: conditionData.nombre,
                protocolo: adaptProtocol(conditionData.protocolo, data),
                terapias: data.therapies,
                exclusiones: data.exclusions,
                menu: generateWeekMenu(conditionData, data)
            };
        }

        function createEvolutionaryPlan(data) {
            const conditionData = baseDatosRedox[data.condition];
            const duration = parseInt(data.duration);
            const phases = getPhaseStructure(duration);
            
            return {
                tipo: 'evolutivo',
                paciente: data.patientName,
                condicion: conditionData.nombre,
                duracion: duration,
                protocolo: adaptProtocol(conditionData.protocolo, data),
                terapias: data.therapies,
                exclusiones: data.exclusiones,
                fases: phases.map((phase, index) => ({
                    numero: index + 1,
                    nombre: phase.nombre,
                    semanas: phase.semanas,
                    objetivo: getPhaseObjective(data.condition, index + 1),
                    menus: phase.semanas.map(semana => ({
                        semana: semana,
                        menu: generateWeekMenu(conditionData, data, index + 1, semana)
                    }))
                }))
            };
        }

        function getPhaseStructure(duration) {
            const structures = {
                4: [
                    { nombre: "Choque Intensivo", semanas: [1, 2] },
                    { nombre: "Estabilización", semanas: [3, 4] }
                ],
                8: [
                    { nombre: "Choque", semanas: [1, 2] },
                    { nombre: "Estabilización", semanas: [3, 4] },
                    { nombre: "Optimización", semanas: [5, 6] },
                    { nombre: "Consolidación", semanas: [7, 8] }
                ],
                12: [
                    { nombre: "Choque", semanas: [1, 2, 3] },
                    { nombre: "Estabilización", semanas: [4, 5, 6] },
                    { nombre: "Optimización", semanas: [7, 8, 9] },
                    { nombre: "Mantenimiento", semanas: [10, 11, 12] }
                ],
                16: [
                    { nombre: "Choque", semanas: [1, 2, 3, 4] },
                    { nombre: "Estabilización", semanas: [5, 6, 7, 8] },
                    { nombre: "Optimización", semanas: [9, 10, 11, 12] },
                    { nombre: "Vida Nueva", semanas: [13, 14, 15, 16] }
                ]
            };
            return structures[duration] || structures[8];
        }

        function getPhaseObjective(condition, phaseNumber) {
            const objectives = {
                estreñimiento: [
                    "Reactivación inmediata de motilidad intestinal mediante hidratación + MCT + infrarrojo",
                    "Estabilización del tránsito + introducción fermentados naturales + fibra prebiótica",
                    "Optimización microbiota + consolidación hábitos + reducción dependencias",
                    "Mantenimiento sostenible + estilo de vida Redox + autonomía completa"
                ],
                sop: [
                    "Modulación hormonal intensiva + reducción inflamación + sensibilidad insulínica",
                    "Estabilización ciclos + regulación andrógenos + optimización metabolismo",
                    "Consolidación equilibrio hormonal + mejora composición corporal",
                    "Mantenimiento natural + fertilidad óptima + bienestar integral"
                ],
                'perdida-peso': [
                    "Choque metabólico + activación lipolisis + cetosis nutricional",
                    "Estabilización pérdida + mantenimiento masa muscular + metabolismo",
                    "Optimización composición corporal + metabolismo flexible + hábitos",
                    "Mantenimiento peso ideal + estilo vida saludable + prevención rebote"
                ],
                inflamacion: [
                    "Reducción inflamación aguda + modulación inmune + eliminación triggers",
                    "Estabilización marcadores + reparación tisular + función intestinal",
                    "Optimización sistema inmune + regeneración completa + vitalidad",
                    "Mantenimiento anti-inflamatorio + prevención + salud óptima"
                ]
            };
            return objectives[condition] ? objectives[condition][phaseNumber - 1] : `Fase ${phaseNumber} de tratamiento integral Redox`;
        }

        function adaptProtocol(baseProtocol, data) {
            let adaptedProtocol = baseProtocol;
            
            // Agregar terapias seleccionadas
            if (data.therapies.includes('infrarrojo')) {
                adaptedProtocol += " • Infrarrojo diario 20-30min";
            }
            if (data.therapies.includes('termogenesis')) {
                adaptedProtocol += " • Termogénesis 3x/semana";
            }
            if (data.therapies.includes('vagal')) {
                adaptedProtocol += " • Estimulación vagal diaria";
            }
            
            // Adaptaciones por condiciones secundarias
            data.secondaryConditions.forEach(condition => {
                switch(condition) {
                    case 'fatiga-cronica':
                        adaptedProtocol += " • Vitaminas B naturales • Hierro hemo";
                        break;
                    case 'problemas-sueño':
                        adaptedProtocol += " • Magnesio nocturno • Infusiones relajantes";
                        break;
                    case 'ansiedad-estres':
                        adaptedProtocol += " • Adaptógenos • Técnicas respiración";
                        break;
                    case 'caida-cabello':
                        adaptedProtocol += " • Biotina natural • Zinc • Proteínas específicas";
                        break;
                    case 'problemas-piel':
                        adaptedProtocol += " • Omega-3 • Antioxidantes • Zinc";
                        break;
                    case 'problemas-digestivos':
                        adaptedProtocol += " • Probióticos • L-Glutamina • Enzimas";
                        break;
                }
            });
            
            return adaptedProtocol;
        }

        function generateWeekMenu(conditionData, data, phase = 1, weekNumber = 1) {
            const days = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO', 'DOMINGO'];
            
            return days.map((dia, dayIndex) => ({
                dia: dia,
                comidas: conditionData.momentos.map((momento, momentoIndex) => {
                    let alimento = getAlimentoForMoment(conditionData, momento, dayIndex, phase, weekNumber);
                    
                    // Aplicar exclusiones
                    alimento = applyExclusions(alimento, data.exclusions);
                    
                    // Adaptar según condiciones secundarias
                    alimento = adaptForSecondaryConditions(alimento, data.secondaryConditions, momento);
                    
                    return {
                        momento: momento,
                        horario: conditionData.horarios[momentoIndex],
                        alimento: alimento
                    };
                })
            }));
        }

        function getAlimentoForMoment(conditionData, momento, dayIndex, phase, weekNumber) {
            const momentoKey = momento.toLowerCase();
            let alimentosArray = [];
            
            switch(momentoKey) {
                case 'despertar':
                    alimentosArray = conditionData.alimentos.despertar || [];
                    break;
                case 'desayuno':
                    alimentosArray = conditionData.alimentos.desayunos || [];
                    break;
                case 'almuerzo':
                    alimentosArray = conditionData.alimentos.almuerzos || [];
                    break;
                case 'comida':
                    alimentosArray = conditionData.alimentos.comidas || [];
                    break;
                case 'merienda':
                    alimentosArray = conditionData.alimentos.meriendas || [];
                    break;
                case 'cena':
                    alimentosArray = conditionData.alimentos.cenas || [];
                    break;
                default:
                    alimentosArray = [`${momento} específico según protocolo`];
            }
            
            if (alimentosArray.length === 0) {
                return `${momento} según protocolo Redox`;
            }
            
            // Seleccionar alimento basado en día y fase para variedad
            const index = (dayIndex + (phase - 1) * 7 + (weekNumber - 1)) % alimentosArray.length;
            return alimentosArray[index];
        }

        function applyExclusions(alimento, exclusions) {
            let result = alimento;
            
            exclusions.forEach(exclusion => {
                switch(exclusion) {
                    case 'sin-huevos':
                        result = result.replace(/huevos?|tortilla|revuelto/gi, 'proteína alternativa');
                        break;
                    case 'sin-lacteos':
                        result = result.replace(/mantequilla|kéfir|queso|leche/gi, 'alternativa vegetal');
                        break;
                    case 'sin-frutos-secos':
                        result = result.replace(/nueces|almendras|avellanas/gi, 'semillas');
                        break;
                    case 'sin-gluten':
                        result = result.replace(/avena|pan|trigo/gi, 'alternativa sin gluten');
                        break;
                }
            });
            
            return result;
        }

        function adaptForSecondaryConditions(alimento, secondaryConditions, momento) {
            let adaptedAlimento = alimento;
            
            secondaryConditions.forEach(condition => {
                switch(condition) {
                    case 'fatiga-cronica':
                        if (momento === 'DESAYUNO') {
                            adaptedAlimento += " + Espinacas (hierro natural)";
                        }
                        break;
                    case 'caida-cabello':
                        if (momento === 'COMIDA') {
                            adaptedAlimento += " + Semillas calabaza (zinc)";
                        }
                        break;
                    case 'problemas-sueño':
                        if (momento === 'CENA') {
                            adaptedAlimento += " + Manzanilla";
                        }
                        break;
                    case 'problemas-piel':
                        if (momento === 'COMIDA') {
                            adaptedAlimento += " + Omega-3 extra";
                        }
                        break;
                    case 'ansiedad-estres':
                        if (momento === 'MERIENDA') {
                            adaptedAlimento += " + Magnesio natural";
                        }
                        break;
                    case 'problemas-digestivos':
                        if (momento === 'DESPERTAR') {
                            adaptedAlimento += " + Probióticos";
                        }
                        break;
                }
            });
            
            return adaptedAlimento;
        }

        function displayPlan(plan) {
            const preview = document.getElementById('menuPreview');
            let html = '';
            
            if (plan.tipo === 'semanal') {
                html = displayWeeklyPlan(plan);
            } else {
                html = displayEvolutionaryPlan(plan);
            }
            
            preview.innerHTML = html;
        }

        function displayWeeklyPlan(plan) {
            let html = `
                <h3>📋 Menú Semanal Redox para: ${plan.paciente}</h3>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 20px 0;">
                    <p><strong>🎯 Condición:</strong> ${plan.condicion}</p>
                    <p><strong>📋 Protocolo:</strong> ${plan.protocolo}</p>
                    ${plan.terapias.length > 0 ? `<p><strong>⚕️ Terapias:</strong> ${plan.terapias.join(', ')}</p>` : ''}
                    ${plan.exclusiones.length > 0 ? `<p><strong>🚫 Exclusiones:</strong> ${plan.exclusiones.join(', ')}</p>` : ''}
                </div>
                
                <table class="menu-table">
                    <thead>
                        <tr>
                            <th style="width: 120px;">Horario</th>
                            <th>LUNES</th>
                            <th>MARTES</th>
                            <th>MIÉRCOLES</th>
                            <th>JUEVES</th>
                            <th>VIERNES</th>
                            <th>SÁBADO</th>
                            <th>DOMINGO</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Obtener todos los momentos únicos
            const momentos = [...new Set(plan.menu.flatMap(dia => dia.comidas.map(c => c.momento)))];
            
            momentos.forEach(momento => {
                html += `<tr>`;
                
                // Obtener horario del primer día que tenga este momento
                const horario = plan.menu.find(dia => 
                    dia.comidas.some(c => c.momento === momento)
                )?.comidas.find(c => c.momento === momento)?.horario || '';
                
                html += `<td class="meal-label">${momento}<br><small style="font-weight: normal; font-size: 0.8em;">${horario}</small></td>`;
                
                plan.menu.forEach(dia => {
                    const comida = dia.comidas.find(c => c.momento === momento);
                    html += `<td>${comida ? comida.alimento : '-'}</td>`;
                });
                
                html += `</tr>`;
            });
            
            html += `
                    </tbody>
                </table>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">📝 Notas Importantes</h4>
                    <ul style="margin-left: 20px; color: #6c757d;">
                        <li>Seguir horarios de forma estricta para optimizar ritmos circadianos</li>
                        <li>Hidratación: mínimo 2.5-3L diarios distribuidos entre comidas</li>
                        <li>Masticación consciente: mínimo 20-30 masticaciones por bocado</li>
                        <li>Evaluación semanal de síntomas y ajustes según respuesta</li>
                        ${plan.terapias.includes('infrarrojo') ? '<li>Terapia infrarroja: diaria 20-30 min, preferentemente post-comida</li>' : ''}
                        ${plan.terapias.includes('termogenesis') ? '<li>Termogénesis: 3 sesiones semanales, progresión gradual</li>' : ''}
                    </ul>
                </div>
            `;
            
            return html;
        }

        function displayEvolutionaryPlan(plan) {
            let html = `
                <h3>🔄 Plan Evolutivo Redox para: ${plan.paciente}</h3>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 20px 0;">
                    <p><strong>🎯 Condición:</strong> ${plan.condicion}</p>
                    <p><strong>⏱️ Duración:</strong> ${plan.duracion} semanas</p>
                    <p><strong>📋 Protocolo Base:</strong> ${plan.protocolo}</p>
                    ${plan.terapias.length > 0 ? `<p><strong>⚕️ Terapias:</strong> ${plan.terapias.join(', ')}</p>` : ''}
                    ${plan.exclusiones.length > 0 ? `<p><strong>🚫 Exclusiones:</strong> ${plan.exclusiones.join(', ')}</p>` : ''}
                </div>
            `;
            
            plan.fases.forEach(fase => {
                html += `
                    <div class="phase-card">
                        <div class="phase-header">
                            <div class="phase-number">${fase.numero}</div>
                            <div class="phase-title">
                                <h4>FASE ${fase.numero}: ${fase.nombre.toUpperCase()}</h4>
                                <p>Semanas ${fase.semanas.join(', ')} • ${fase.objetivo}</p>
                            </div>
                        </div>
                `;
                
                fase.menus.forEach(menuSemana => {
                    html += `
                        <div class="week-menu">
                            <div class="week-title">📅 SEMANA ${menuSemana.semana}</div>
                            <table class="menu-table" style="margin: 10px 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Momento</th>
                                        <th>LUN</th><th>MAR</th><th>MIÉ</th><th>JUE</th><th>VIE</th><th>SÁB</th><th>DOM</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Obtener momentos únicos para esta semana
                    const momentos = [...new Set(menuSemana.menu.flatMap(dia => dia.comidas.map(c => c.momento)))];
                    
                    momentos.forEach(momento => {
                        html += `<tr>`;
                        html += `<td class="meal-label" style="font-size: 0.75em; padding: 5px;">${momento}</td>`;
                        
                        menuSemana.menu.forEach(dia => {
                            const comida = dia.comidas.find(c => c.momento === momento);
                            html += `<td style="font-size: 0.75em; padding: 5px;">${comida ? comida.alimento.substring(0, 50) + '...' : '-'}</td>`;
                        });
                        
                        html += `</tr>`;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">🎯 Cronograma de Objetivos</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            `;
            
            plan.fases.forEach(fase => {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db;">
                        <h5 style="color: #2c3e50; margin-bottom: 5px;">Fase ${fase.numero}: ${fase.nombre}</h5>
                        <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 5px;">Semanas ${fase.semanas.join('-')}</p>
                        <p style="font-size: 0.85em; color: #495057;">${fase.objetivo}</p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function goBack() {
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('formSection').style.display = 'block';
        }

        function downloadPDF() {
            if (!menuGenerado) {
                alert('No hay menú generado para descargar');
                return;
            }
            
            // Crear contenido HTML para impresión
            const printContent = document.getElementById('menuPreview').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Plan Redox - ${menuGenerado.paciente}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #2c3e50; }
                        .menu-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .menu-table th, .menu-table td { border: 1px solid #ddd; padding: 8px; font-size: 0.8em; }
                        .menu-table th { background: #f8f9fa; font-weight: bold; }
                        .meal-label { background: #f8f9fa; font-weight: bold; }
                        .phase-card { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
                        .week-menu { margin: 15px 0; padding: 10px; background: #f8f9fa; }
                        h3, h4 { color: #2c3e50; }
                        @media print { body { margin: 10px; font-size: 12px; } }
                    </style>
                </head>
                <body>
                    <h1>🌱 Plan Nutricional Redox</h1>
                    <p><strong>Generado el:</strong> ${new Date().toLocaleDateString('es-ES')}</p>
                    <p><strong>Dietaryplus - Filosofía Redox</strong></p>
                    <hr>
                    ${printContent}
                    <hr>
                    <p style="text-align: center; color: #6c757d; font-size: 0.9em;">
                        © Dietaryplus - www.dietaryplus.com<br>
                        Plan generado con Metodología Redox
                    </p>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }
        
        // Test básico para verificar funcionamiento
		
        function testFunction() {
            console.log('JavaScript funcionando correctamente');
        }
        
        console.log('Script cargado correctamente - Versión completa');
    </script>
</body>
</html>
