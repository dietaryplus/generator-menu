<!-- STEP 4: Configuraci√≥n -->
            <div class="step-content" data-step="4">
                <div class="form-section">
                    <h3>Configuraci√≥n del Plan</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nombrePlan">Nombre del Plan:</label>
                            <input type="text" id="nombrePlan" placeholder="Plan personalizado para [nombre]">
                        </div>
                        
                        <div class="form-group">
                            <label for="intensidadPlan">Intensidad:</label>
                            <select id="intensidadPlan">
                                <option value="suave">Suave - Cambios graduales</option>
                                <option value="moderada" selected>Moderada - Equilibrada</option>
                                <option value="intensiva">Intensiva - Cambios r√°pidos</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="enfoqueEspecial">Enfoque Especial:</label>
                            <select id="enfoqueEspecial">
                                <option value="">Est√°ndar</option>
                                <option value="deportista">Deportista/Activo</option>
                                <option value="sedentario">Sedentario</option>
                                <option value="edad-avanzada">Edad Avanzada</option>
                                <option value="embarazo">Embarazo/Lactancia</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Terapias F√≠sicas Redox</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            Selecciona las terapias f√≠sicas que se incluir√°n en el plan:
                        </p>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="terapia-infrarrojo" value="infrarrojo" checked>
                                <label for="terapia-infrarrojo">Terapia Infrarrojo</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="terapia-termogenesis" value="termogenesis">
                                <label for="terapia-termogenesis">Termog√©nesis</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="terapia-vagal" value="vagal" checked>
                                <label for="terapia-vagal">Estimulaci√≥n Vagal</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="terapia-respiracion" value="respiracion">
                                <label for="terapia-respiracion">T√©cnicas Respiraci√≥n</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Exclusiones Alimentarias</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            Marca los alimentos que deben excluirse del plan:
                        </p>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="excl-gluten" value="sin-gluten">
                                <label for="excl-gluten">Sin Gluten</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="excl-lacteos" value="sin-lacteos">
                                <label for="excl-lacteos">Sin L√°cteos</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="excl-huevos" value="sin-huevos">
                                <label for="excl-huevos">Sin Huevos</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="excl-frutos-secos" value="sin-frutos-secos">
                                <label for="excl-frutos-secos">Sin Frutos Secos</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="excl-pescado" value="sin-pescado">
                                <label for="excl-pescado">Sin Pescado</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="excl-carne" value="sin-carne">
                                <label for="excl-carne">Sin Carne</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notasEspeciales">Notas Especiales:</label>
                        <textarea id="notasEspeciales" rows="4" placeholder="Cualquier consideraci√≥n adicional, preferencias espec√≠ficas, alergias, medicamentos actuales, etc."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- STEP 5: Generar -->
            <div class="step-content" data-step="5">
                <div id="generationStep">
                    <div class="form-section">
                        <h3>Resumen del Plan</h3>
                        <div id="planSummary" class="plan-preview">
                            <!-- Se llenar√° din√°micamente -->
                        </div>
                        
                        <div style="text-align: center; margin: 30px 0;">
                            <button class="btn btn-success" onclick="generarPlanAutomatico()" id="generateBtn">
                                üöÄ Generar Plan Autom√°tico
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="loadingStep" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <h3>Generando tu plan estrat√©gico...</h3>
                    <p>Creando <span id="loadingWeeks">X</span> semanas personalizadas basadas en la Filosof√≠a Redox</p>
                    <div style="background: var(--light-gray); padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 14px; color: var(--text-secondary);">
                        Aplicando protocolos espec√≠ficos para <span id="loadingCondition">la condici√≥n seleccionada</span>...
                    </div>
                </div>
                
                <div id="successStep" style="display: none;">
                    <div class="success-message">
                        <h3>¬°Plan generado exitosamente!</h3>
                        <p>Tu plan estrat√©gico ha sido creado y guardado en la base de datos</p>
                    </div>
                    
                    <div id="generatedPlanPreview" class="plan-preview">
                        <!-- Vista previa del plan generado -->
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="btn" onclick="abrirEditor()">
                            üìù Editar Plan
                        </button>
                        <button class="btn btn-primary" onclick="descargarPlanPDF()">
                            üìÑ Descargar PDF
                        </button>
                        <button class="btn btn-success" onclick="activarPlan()">
                            ‚úÖ Activar Plan
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Wizard Actions -->
            <div class="wizard-actions">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousStep()" disabled>
                    ‚Üê Anterior
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config-supabase.js"></script>
    
    <script>
        // VARIABLES GLOBALES
        let supabase;
        let currentStep = 1;
        let wizardData = {
            paciente: null,
            duracion: null,
            condicion_principal: null,
            condiciones_secundarias: [],
            terapias_fisicas: [],
            configuracion: {},
            planGenerado: null
        };
        
        let pacientesData = [];
        let isConnected = false;
        
        // INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
            setupEventListeners();
        });
        
        async function initializeApp() {
            try {
                // Usar configuraci√≥n unificada si est√° disponible
                if (typeof window.REDOX_CONFIG !== 'undefined') {
                    supabase = await window.REDOX_CONFIG.SUPABASE_HELPERS.inicializar();
                    updateConnectionStatus('connected', 'Conectado a Redox DB');
                } else {
                    // Fallback si no est√° disponible la configuraci√≥n
                    supabase = window.supabase.createClient(
                        'https://uuoxzoqjbquqpvjhszsi.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1b3h6b3FqYnF1cXB2amhzenNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNzMzMTksImV4cCI6MjA3Mzk0OTMxOX0.u5Ozw8L83w8oXBluZLUr_gX4PGr5GVlX2FcllFruqtY'
                    );
                    updateConnectionStatus('connected', 'Conectado');
                }
                
                isConnected = true;
                await cargarPacientes();
                cargarBorrador(); // Cargar borrador si existe
                
            } catch (error) {
                console.error('Error inicializando aplicaci√≥n:', error);
                updateConnectionStatus('disconnected', 'Error de conexi√≥n');
                mostrarNotificacion('Error de conexi√≥n con la base de datos', 'error');
            }
        }
        
        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-indicator ${status}`;
            statusElement.innerHTML = `<span>‚óè</span> ${text}`;
        }
        
        async function cargarPacientes() {
            try {
                let data, error;
                
                if (typeof window.REDOX_CONFIG !== 'undefined') {
                    ({ data, error } = await window.REDOX_CONFIG.CONSULTAS.obtenerPacientesActivos(supabase));
                } else {
                    ({ data, error } = await supabase
                        .from('pacientes')
                        .select('*')
                        .in('estado', ['activo', 'pausado'])
                        .order('nombre_completo'));
                }
                
                if (error) throw error;
                
                pacientesData = data || [];
                poblarSelectPacientes();
                
            } catch (error) {
                console.error('Error cargando pacientes:', error);
                mostrarNotificacion('Error cargando pacientes', 'error');
                pacientesData = [];
                poblarSelectPacientes();
            }
        }
        
        function poblarSelectPacientes() {
            const select = document.getElementById('pacienteSelect');
            const noMessage = document.getElementById('noPacientesMessage');
            
            if (pacientesData.length === 0) {
                select.innerHTML = '<option value="">No hay pacientes registrados</option>';
                noMessage.style.display = 'block';
                return;
            }
            
            select.innerHTML = '<option value="">Seleccionar paciente...</option>';
            noMessage.style.display = 'none';
            
            pacientesData.forEach(paciente => {
                const option = document.createElement('option');
                option.value = paciente.id;
                option.textContent = `${paciente.nombre_completo}`;
                option.dataset.paciente = JSON.stringify(paciente);
                select.appendChild(option);
            });
        }
        
        function setupEventListeners() {
            // Selecci√≥n de paciente
            document.getElementById('pacienteSelect').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value && selectedOption.dataset.paciente) {
                    const paciente = JSON.parse(selectedOption.dataset.paciente);
                    wizardData.paciente = paciente;
                    mostrarInfoPaciente(paciente);
                    
                    // Auto-llenar nombre del plan
                    document.getElementById('nombrePlan').value = `Plan Redox - ${paciente.nombre_completo}`;
                } else {
                    wizardData.paciente = null;
                    document.getElementById('pacienteInfo').style.display = 'none';
                }
            });
            
            // Selecci√≥n de duraci√≥n
            document.querySelectorAll('.duration-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.duration-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const duracion = parseInt(this.dataset.duration);
                    wizardData.duracion = duracion;
                    mostrarPreviewDuracion(duracion);
                });
            });
            
            // Selecci√≥n de condici√≥n principal
            document.querySelectorAll('.condition-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.condition-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    wizardData.condicion_principal = this.dataset.condition;
                });
            });
            
            // Condiciones secundarias
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const value = this.value;
                    
                    if (this.id.startsWith('sec-')) {
                        // Condiciones secundarias
                        if (this.checked) {
                            if (!wizardData.condiciones_secundarias.includes(value)) {
                                wizardData.condiciones_secundarias.push(value);
                            }
                        } else {
                            wizardData.condiciones_secundarias = wizardData.condiciones_secundarias.filter(c => c !== value);
                        }
                    } else if (this.id.startsWith('terapia-')) {
                        // Terapias f√≠sicas
                        if (this.checked) {
                            if (!wizardData.terapias_fisicas.includes(value)) {
                                wizardData.terapias_fisicas.push(value);
                            }
                        } else {
                            wizardData.terapias_fisicas = wizardData.terapias_fisicas.filter(t => t !== value);
                        }
                    }
                });
            });
            
            // Inicializar terapias por defecto
            wizardData.terapias_fisicas = ['infrarrojo', 'vagal'];
        }
        
        function mostrarInfoPaciente(paciente) {
            const info = document.getElementById('pacienteInfo');
            const details = document.getElementById('pacienteDetails');
            
            const edad = paciente.fecha_nacimiento ? calcularEdad(paciente.fecha_nacimiento) : 'No especificada';
            
            details.innerHTML = `
                <div><strong>Nombre:</strong> ${paciente.nombre_completo}</div>
                <div><strong>ID:</strong> ${paciente.id.substring(0, 8)}...</div>
                <div><strong>Email:</strong> ${paciente.email || 'No registrado'}</div>
                <div><strong>Edad:</strong> ${edad}${typeof edad === 'number' ? ' a√±os' : ''}</div>
                <div><strong>Condici√≥n:</strong> ${paciente.condicion_principal || 'No especificada'}</div>
                <div><strong>Estado:</strong> <span class="status-badge ${paciente.estado || 'activo'}">${paciente.estado || 'Activo'}</span></div>
                ${paciente.objetivo_tratamiento ? `
                    <div style="grid-column: 1 / -1; margin-top: 10px;"><strong>Objetivo:</strong> ${paciente.objetivo_tratamiento}</div>
                ` : ''}
                ${paciente.notas ? `
                    <div style="grid-column: 1 / -1; margin-top: 10px;"><strong>Notas:</strong> ${paciente.notas}</div>
                ` : ''}
            `;
            
            info.style.display = 'block';
        }
        
        function calcularEdad(fechaNacimiento) {
            const hoy = new Date();
            const nacimiento = new Date(fechaNacimiento);
            let edad = hoy.getFullYear() - nacimiento.getFullYear();
            const mes = hoy.getMonth() - nacimiento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                edad--;
            }
            
            return edad;
        }
        
        function mostrarPreviewDuracion(duracion) {
            const preview = document.getElementById('durationPreview');
            const details = document.getElementById('phaseDetails');
            
            let faseInfo = '';
            if (duracion === 4) {
                faseInfo = `
                    <h5 style="margin-bottom: 15px;">Estructura del Plan Intensivo (4 semanas):</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info-blue);">
                            <strong>Semanas 1-2:</strong><br>
                            Fase inicial intensiva - Fundamentos
                        </div>
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success-green);">
                            <strong>Semanas 3-4:</strong><br>
                            Consolidaci√≥n y optimizaci√≥n
                        </div>
                    </div>
                `;
            } else if (duracion === 8) {
                faseInfo = `
                    <h5 style="margin-bottom: 15px;">Estructura del Plan Est√°ndar (8 semanas):</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info-blue);">
                            <strong>Semanas 1-2:</strong><br>
                            Fundaci√≥n y adaptaci√≥n
                        </div>
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning-orange);">
                            <strong>Semanas 3-4:</strong><br>
                            Intensificaci√≥n
                        </div>
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success-green);">
                            <strong>Semanas 5-6:</strong><br>
                            Optimizaci√≥n
                        </div>
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-black);">
                            <strong>Semanas 7-8:</strong><br>
                            Mantenimiento
                        </div>
                    </div>
                `;
            } else if (duracion === 16) {
                faseInfo = `
                    <h5 style="margin-bottom: 15px;">Estructura del Plan Completo (16 semanas):</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info-blue);">
                            <strong>Fase 1 (1-4):</strong><br>
                            Fundaci√≥n integral
                        </div>
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning-orange);">
                            <strong>Fase 2 (5-8):</strong><br>
                            Desarrollo progresivo
                        </div>
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success-green);">
                            <strong>Fase 3 (9-12):</strong><br>
                            Intensificaci√≥n m√°xima
                        </div>
                        <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-black);">
                            <strong>Fase 4 (13-16):</strong><br>
                            Consolidaci√≥n final
                        </div>
                    </div>
                `;
            }
            
            details.innerHTML = faseInfo + `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center;">
                    <strong>Total de comidas generadas:</strong> ${duracion * 35}<br>
                    <strong>Recetas √∫nicas programadas:</strong> ${Math.min(duracion * 5, 50)}
                </div>
            `;
            
            preview.style.display = 'block';
            document.getElementById('loadingWeeks').textContent = duracion;
        }
        
        // NAVEGACI√ìN DEL WIZARD
        function nextStep() {
            if (!validarStep(currentStep)) return;
            
            if (currentStep === 4) {
                recopilarConfiguracion();
                mostrarResumenPlan();
            }
            
            if (currentStep < 5) {
                currentStep++;
                updateStepDisplay();
                guardarEstadoActual(); // Guardar autom√°ticamente
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }
        
        function validarStep(step) {
            switch(step) {
                case 1:
                    if (!wizardData.paciente) {
                        mostrarNotificacion('Por favor selecciona un paciente', 'error');
                        return false;
                    }
                    return true;
                    
                case 2:
                    if (!wizardData.duracion) {
                        mostrarNotificacion('Por favor selecciona la duraci√≥n del plan', 'error');
                        return false;
                    }
                    return true;
                    
                case 3:
                    if (!wizardData.condicion_principal) {
                        mostrarNotificacion('Por favor selecciona la condici√≥n principal', 'error');
                        return false;
                    }
                    return true;
                    
                case 4:
                    return true;
                    
                default:
                    return true;
            }
        }
        
        function updateStepDisplay() {
            // Actualizar header steps
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');
                
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // Actualizar contenido
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
                if (parseInt(content.dataset.step) === currentStep) {
                    content.classList.add('active');
                }
            });
            
            // Actualizar botones
            document.getElementById('prevBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').style.display = currentStep === 5 ? 'none' : 'block';
        }
        
        function recopilarConfiguracion() {
            // Recopilar exclusiones
            const exclusiones = Array.from(document.querySelectorAll('input[id^="excl-"]:checked')).map(cb => cb.value);
            
            // Recopilar terapias f√≠sicas
            const terapias = Array.from(document.querySelectorAll('input[id^="terapia-"]:checked')).map(cb => cb.value);
            
            wizardData.configuracion = {
                nombre_plan: document.getElementById('nombrePlan').value || `Plan para ${wizardData.paciente.nombre_completo}`,
                intensidad: document.getElementById('intensidadPlan').value,
                enfoque_especial: document.getElementById('enfoqueEspecial').value,
                exclusiones: exclusiones,
                terapias_fisicas: terapias,
                notas_especiales: document.getElementById('notasEspeciales').value
            };
        }
        
        function mostrarResumenPlan() {
            const summary = document.getElementById('planSummary');
            
            const condicionesSecundariasText = wizardData.condiciones_secundarias.length > 0 
                ? wizardData.condiciones_secundarias.join(', ') 
                : 'Ninguna';
            
            const exclusionesText = wizardData.configuracion.exclusiones.length > 0 
                ? wizardData.configuracion.exclusiones.join(', ') 
                : 'Ninguna';
            
            const terapiasText = wizardData.configuracion.terapias_fisicas.length > 0 
                ? wizardData.configuracion.terapias_fisicas.join(', ') 
                : 'Ninguna';
            
            summary.innerHTML = `
                <h4 style="margin-bottom: 20px;">Resumen del Plan a Generar</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="background: var(--white); padding: 20px; border-radius: 8px; border-left: 4px solid var(--info-blue);">
                        <strong>Paciente:</strong><br>
                        ${wizardData.paciente.nombre_completo}<br>
                        <small style="color: var(--text-secondary);">ID: ${wizardData.paciente.id.substring(0, 8)}...</small>
                    </div>
                    <div style="background: var(--white); padding: 20px; border-radius: 8px; border-left: 4px solid var(--success-green);">
                        <strong>Duraci√≥n:</strong><br>
                        ${wizardData.duracion} semanas<br>
                        <small style="color: var(--text-secondary);">${wizardData.duracion === 4 ? 'Plan Intensivo' : wizardData.duracion === 8 ? 'Plan Est√°ndar' : 'Plan Completo'}</small>
                    </div>
                    <div style="background: var(--white); padding: 20px; border-radius: 8px; border-left: 4px solid var(--warning-orange);">
                        <strong>Condici√≥n Principal:</strong><br>
                        ${wizardData.condicion_principal}<br>
                        <small style="color: var(--text-secondary);">Intensidad: ${wizardData.configuracion.intensidad}</small>
                    </div>
                    <div style="background: var(--white); padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary-black);">
                        <strong>Configuraci√≥n:</strong><br>
                        ${wizardData.condiciones_secundarias.length} condiciones adicionales<br>
                        <small style="color: var(--text-secondary);">${wizardData.configuracion.terapias_fisicas.length} terapias f√≠sicas</small>
                    </div>
                </div>
                
                <div style="background: var(--light-gray); padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Condiciones Secundarias:</strong><br>
                            <span style="color: var(--text-secondary);">${condicionesSecundariasText}</span>
                        </div>
                        <div>
                            <strong>Terapias F√≠sicas:</strong><br>
                            <span style="color: var(--text-secondary);">${terapiasText}</span>
                        </div>
                        <div>
                            <strong>Exclusiones:</strong><br>
                            <span style="color: var(--text-secondary);">${exclusionesText}</span>
                        </div>
                    </div>
                </div>
                
                ${wizardData.configuracion.notas_especiales ? `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #ffeaa7;">
                        <strong>Notas Especiales:</strong><br>
                        ${wizardData.configuracion.notas_especiales}
                    </div>
                ` : ''}
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center; border: 1px solid #c8e6c9;">
                    <strong>Se generar√°n ${wizardData.duracion} semanas</strong> con aproximadamente <strong>${wizardData.duracion * 35} comidas personalizadas</strong><br>
                    <small style="color: var(--text-secondary);">Basado en los principios de la Filosof√≠a Redox de Dietaryplus</small>
                </div>
            `;
            
            // Actualizar indicadores de carga
            document.getElementById('loadingCondition').textContent = wizardData.condicion_principal;
        }
        
        // GENERACI√ìN DEL PLAN
        async function generarPlanAutomatico() {
            if (!isConnected) {
                mostrarNotificacion('No hay conexi√≥n con la base de datos', 'error');
                return;
            }
            
            document.getElementById('generationStep').style.display = 'none';
            document.getElementById('loadingStep').style.display = 'block';
            
            try {
                // 1. Crear el plan principal
                const planData = {
                    paciente_id: wizardData.paciente.id,
                    nombre_plan: wizardData.configuracion.nombre_plan,
                    tipo_plan: wizardData.condicion_principal,
                    duracion_semanas: wizardData.duracion,
                    condicion_principal: wizardData.condicion_principal,
                    condiciones_secundarias: wizardData.condiciones_secundarias,
                    terapias_fisicas: wizardData.configuracion.terapias_fisicas,
                    exclusiones_alimentarias: wizardData.configuracion.exclusiones,
                    estado: 'borrador',
                    notas_nutricionista: wizardData.configuracion.notas_especiales,
                    contenido_plan: await generarContenidoPlan()
                };
                
                const { data: planCreado, error: errorPlan } = await supabase
                    .from('planes_generados')
                    .insert([planData])
                    .select()
                    .single();
                
                if (errorPlan) throw errorPlan;
                
                // 2. Generar las semanas detalladas (opcional, si existe la tabla)
                await intentarGenerarSemanas(planCreado);
                
                wizardData.planGenerado = planCreado;
                mostrarPlanGenerado();
                
                // Notificar al dashboard si est√° disponible
                notificarDashboard('plan-generated', {
                    planId: planCreado.id,
                    pacienteId: wizardData.paciente.id
                });
                
                // Limpiar borrador
                localStorage.removeItem('borrador_plan_redox');
                
            } catch (error) {
                console.error('Error generando plan:', error);
                mostrarNotificacion('Error generando el plan: ' + error.message, 'error');
                
                document.getElementById('loadingStep').style.display = 'none';
                document.getElementById('generationStep').style.display = 'block';
            }
        }
        
        async function intentarGenerarSemanas(plan) {
            try {
                const semanas = [];
                
                for (let semana = 1; semana <= wizardData.duracion; semana++) {
                    const fase = determinarFase(semana, wizardData.duracion);
                    const semanaData = {
                        plan_id: plan.id,
                        numero_semana: semana,
                        nombre_fase: `Semana ${semana} - Fase ${fase}`,
                        objetivos_semana: [`Objetivos espec√≠ficos para semana ${semana}`],
                        enfoque_semanal: getEnfoqueSemanal(wizardData.condicion_principal, semana),
                        notas_semana: ''
                    };
                    
                    semanas.push(semanaData);
                }
                
                // Intentar insertar semanas
                const { error: errorSemanas } = await supabase
                    .from('semanas_plan')
                    .insert(semanas);
                
                if (errorSemanas) {
                    console.log('Tabla semanas_plan no existe, continuando sin semanas detalladas');
                }
            } catch (error) {
                console.log('No se pudieron crear semanas detalladas:', error.message);
            }
        }
        
        function determinarFase(numeroSemana, duracionTotal) {
            if (duracionTotal === 4) {
                return numeroSemana <= 2 ? 1 : 2;
            } else if (duracionTotal === 8) {
                return Math.ceil(numeroSemana / 2);
            } else if (duracionTotal === 16) {
                return Math.ceil(numeroSemana / 4);
            }
            return 1;
        }
        
        function getEnfoqueSemanal(condicion, semana) {
            const enfoques = {
                'sop': [
                    'Antiinflamatorio inicial y regulaci√≥n insul√≠nica',
                    'Intensificaci√≥n hormonal y modulaci√≥n androg√©nica',
                    'Optimizaci√≥n metab√≥lica y control de peso',
                    'Consolidaci√≥n y mantenimiento hormonal'
                ],
                'estre√±imiento': [
                    'Hidrataci√≥n intensiva y reparaci√≥n intestinal',
                    'Modulaci√≥n de microbiota y fibra espec√≠fica',
                    'Optimizaci√≥n del tr√°nsito y motilidad',
                    'Mantenimiento y prevenci√≥n de reca√≠das'
                ],
                'perdida-peso': [
                    'Activaci√≥n metab√≥lica y termog√©nesis',
                    'Optimizaci√≥n de composici√≥n corporal',
                    'Intensificaci√≥n de p√©rdida grasa',
                    'Mantenimiento y prevenci√≥n rebote'
                ],
                'inflamacion': [
                    'Antiinflamatorio intensivo inicial',
                    'Modulaci√≥n inmune y antioxidantes',
                    'Reparaci√≥n tisular y regeneraci√≥n',
                    'Mantenimiento antiinflamatorio'
                ]
            };
            
            const fases = enfoques[condicion] || ['Enfoque nutricional personalizado'];
            const faseIndex = Math.min(Math.floor((semana - 1) / Math.max(1, wizardData.duracion / 4)), fases.length - 1);
            return fases[faseIndex];
        }
        
        async function generarContenidoPlan() {
            const contenido = {
                tipo: wizardData.condicion_principal,
                duracion_semanas: wizardData.duracion,
                intensidad: wizardData.configuracion.intensidad,
                protocolo_base: getProtocoloBase(wizardData.condicion_principal),
                alimentacion: getAlimentacionBase(wizardData.condicion_principal),
                terapias: wizardData.configuracion.terapias_fisicas,
                exclusiones: wizardData.configuracion.exclusiones,
                condiciones_secundarias: wizardData.condiciones_secundarias,
                enfoque_especial: wizardData.configuracion.enfoque_especial,
                notas: wizardData.configuracion.notas_especiales
            };
            
            return contenido;
        }
        
        function getProtocoloBase(condicion) {
            const protocolos = {
                'sop': 'Ayuno intermitente 16:8 + protocolo antiinflamatorio + regulaci√≥n hormonal natural + terapias f√≠sicas espec√≠ficas',
                'estre√±imiento': 'Hidrataci√≥n intensiva 4-5L/d√≠a + MCT matinal + fibra espec√≠fica + infrarrojo abdominal 2x/d√≠a',
                'perdida-peso': 'Termog√©nesis controlada + ayuno intermitente + optimizaci√≥n metab√≥lica + activaci√≥n BAT',
                'inflamacion': 'Antiinflamatorio intensivo + antioxidantes espec√≠ficos + omega-3 + modulaci√≥n inmune natural'
            };
            
            return protocolos[condicion] || 'Protocolo Redox personalizado';
        }
        
        function getAlimentacionBase(condicion) {
            const alimentacion = {
                'sop': {
                    despertar: 'Hidrataci√≥n + electrolitos naturales',
                    desayuno: 'Prote√≠na alta + grasas antiinflamatorias + antiandrog√©nicos naturales',
                    comida: 'Ensalada abundante + prote√≠na + verduras cruc√≠feras + AOVE',
                    cena: 'Prote√≠na ligera + verduras + infusiones reguladoras hormonales'
                },
                'estre√±imiento': {
                    despertar: 'Agua tibia + lim√≥n + sal marina + 2 cda MCT (obligatorio)',
                    desayuno: 'Grasas espec√≠ficas + mantequilla pasto + aguacate + fibra soluble',
                    comida: 'Pur√© procin√©tico + prote√≠na + AOVE abundante + verduras cocidas',
                    cena: 'Caldo graso + boniato + prote√≠na ligera + infusi√≥n laxante natural'
                },
                'perdida-peso': {
                    despertar: 'Agua + termog√©nicos naturales',
                    desayuno: 'Prote√≠na + MCT + especias termog√©nicas',
                    comida: 'Prote√≠na magra + verduras + grasas saludables controladas',
                    cena: 'Prote√≠na ligera + verduras de hoja verde + ayuno nocturno'
                },
                'inflamacion': {
                    despertar: 'Agua + antioxidantes naturales',
                    desayuno: 'Antiinflamatorios naturales + omega-3 + polifenoles',
                    comida: 'Pescados grasos + vegetales coloridos + especias antiinflamatorias',
                    cena: 'Antioxidantes + c√∫rcuma + jengibre + infusiones reparadoras'
                }
            };
            
            return alimentacion[condicion] || {
                desayuno: 'Protocolo Redox matinal',
                comida: 'Protocolo Redox principal',
                cena: 'Protocolo Redox nocturno'
            };
        }
        
        function mostrarPlanGenerado() {
            document.getElementById('loadingStep').style.display = 'none';
            document.getElementById('successStep').style.display = 'block';
            
            const preview = document.getElementById('generatedPlanPreview');
            preview.innerHTML = `
                <h4>Plan Generado: ${wizardData.planGenerado.nombre_plan}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info-blue);">
                        <strong>Duraci√≥n Total</strong><br>
                        ${wizardData.duracion} semanas
                    </div>
                    <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success-green);">
                        <strong>Comidas Programadas</strong><br>
                        ${wizardData.duracion * 35} comidas
                    </div>
                    <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning-orange);">
                        <strong>Estado</strong><br>
                        Borrador (editable)
                    </div>
                    <div style="background: var(--white); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-black);">
                        <strong>ID del Plan</strong><br>
                        #${wizardData.planGenerado.id.substring(0, 8)}
                    </div>
                </div>
                
                <div style="background: var(--light-gray); padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h5 style="margin-bottom: 15px;">Protocolo Redox Aplicado:</h5>
                    <p style="color: var(--text-secondary); margin-bottom: 10px;">
                        ${wizardData.planGenerado.contenido_plan.protocolo_base}
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
                        <div><strong>Terapias:</strong> ${wizardData.configuracion.terapias_fisicas.length}</div>
                        <div><strong>Exclusiones:</strong> ${wizardData.configuracion.exclusiones.length}</div>
                        <div><strong>Condici√≥n 2¬™:</strong> ${wizardData.condiciones_secundarias.length}</div>
                        <div><strong>Intensidad:</strong> ${wizardData.configuracion.intensidad}</div>
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; border: 1px solid #c8e6c9;">
                    <h5 style="color: #2e7d32; margin-bottom: 10px;">¬°Plan creado exitosamente!</h5>
                    <p style="color: #2e7d32;">
                        El plan ha sido generado autom√°ticamente bas√°ndose en la Filosof√≠a Redox y guardado en la base de datos.<br>
                        Ahora puedes editarlo, activarlo para el paciente o descargarlo como PDF.
                    </p>
                </div>
            `;
        }
        
        // FUNCIONES DE ACCI√ìN POST-GENERACI√ìN
        function abrirEditor() {
            mostrarNotificacion('Editor de planes en desarrollo. Por ahora puedes ver el plan en el dashboard.', 'info');
        }
        
        function descargarPlanPDF() {
            mostrarNotificacion('Funcionalidad de descarga PDF en desarrollo.', 'info');
        }
        
        async function activarPlan() {
            if (!wizardData.planGenerado) {
                mostrarNotificacion('No hay plan generado para activar', 'error');
                return;
            }
            
            if (!confirm('¬øActivar este plan para el paciente? Una vez activado, el paciente podr√° verlo y seguirlo.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('planes_generados')
                    .update({ 
                        estado: 'activo',
                        fecha_inicio: new Date().toISOString().split('T')[0]
                    })
                    .eq('id', wizardData.planGenerado.id);
                
                if (error) throw error;
                
                mostrarNotificacion('Plan activado exitosamente', 'success');
                
                // Notificar al dashboard
                notificarDashboard('plan-activated', {
                    planId: wizardData.planGenerado.id,
                    pacienteId: wizardData.paciente.id
                });
                
                // Actualizar estado en la interfaz
                wizardData.planGenerado.estado = 'activo';
                
            } catch (error) {
                console.error('Error activando plan:', error);
                mostrarNotificacion('Error activando el plan: ' + error.message, 'error');
            }
        }
        
        // GESTI√ìN DE BORRADORES
        function guardarEstadoActual() {
            const borrador = {
                timestamp: new Date().toISOString(),
                currentStep: currentStep,
                wizardData: wizardData
            };
            
            localStorage.setItem('borrador_plan_redox', JSON.stringify(borrador));
        }
        
        async function guardarBorrador() {
            try {
                guardarEstadoActual();
                
                // Tambi√©n intentar guardar en la base de datos si hay un paciente seleccionado
                if (wizardData.paciente && currentStep >= 2) {
                    const borradorDB = {
                        paciente_id: wizardData.paciente.id,
                        nombre_plan: document.getElementById('nombrePlan').value || `Borrador - ${wizardData.paciente.nombre_completo}`,
                        tipo_plan: wizardData.condicion_principal || 'pendiente',
                        duracion_semanas: wizardData.duracion || 8,
                        estado: 'borrador',
                        contenido_plan: {
                            wizard_data: wizardData,
                            step: currentStep,
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    await supabase
                        .from('planes_generados')
                        .insert([borradorDB]);
                }
                
                mostrarNotificacion('Borrador guardado correctamente', 'success');
                document.getElementById('guardarBtn').innerHTML = '‚úÖ Guardado';
                
                setTimeout(() => {
                    document.getElementById('guardarBtn').innerHTML = 'üíæ Guardar Borrador';
                }, 2000);
                
            } catch (error) {
                console.error('Error guardando borrador:', error);
                mostrarNotificacion('Borrador guardado localmente', 'info');
            }
        }
        
        function cargarBorrador() {
            try {
                const borrador = localStorage.getItem('borrador_plan_redox');
                if (borrador) {
                    const data = JSON.parse(borrador);
                    
                    if (data.wizardData && data.currentStep) {
                        wizardData = data.wizardData;
                        currentStep = data.currentStep;
                        
                        // Restaurar interfaz
                        if (wizardData.paciente) {
                            document.getElementById('pacienteSelect').value = wizardData.paciente.id;
                            mostrarInfoPaciente(wizardData.paciente);
                        }
                        
                        if (wizardData.duracion) {
                            document.querySelector(`[data-duration="${wizardData.duracion}"]`)?.classList.add('selected');
                            mostrarPreviewDuracion(wizardData.duracion);
                        }
                        
                        if (wizardData.condicion_principal) {
                            document.querySelector(`[data-condition="${wizardData.condicion_principal}"]`)?.classList.add('selected');
                        }
                        
                        updateStepDisplay();
                        mostrarNotificacion('Borrador cargado autom√°ticamente', 'info');
                    }
                }
            } catch (error) {
                console.error('Error cargando borrador:', error);
            }
        }
        
        function nuevoWizard() {
            if (confirm('¬øEmpezar un nuevo plan? Se perder√°n los datos actuales si no has guardado.')) {
                // Resetear wizard
                currentStep = 1;
                wizardData = {
                    paciente: null,
                    duracion: null,
                    condicion_principal: null,
                    condiciones_secundarias: [],
                    terapias_fisicas: ['infrarrojo', 'vagal'],
                    configuracion: {},
                    planGenerado: null
                };
                
                // Limpiar formularios
                document.getElementById('pacienteSelect').value = '';
                document.getElementById('pacienteInfo').style.display = 'none';
                document.getElementById('nombrePlan').value = '';
                document.getElementById('notasEspeciales').value = '';
                
                // Limpiar selecciones visuales
                document.querySelectorAll('.duration-card').forEach(card => card.classList.remove('selected'));
                document.querySelectorAll('.condition-card').forEach(card => card.classList.remove('selected'));
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = cb.id === 'terapia-infrarrojo' || cb.id === 'terapia-vagal';
                });
                
                // Ocultar previews
                document.getElementById('durationPreview').style.display = 'none';
                
                updateStepDisplay();
                localStorage.removeItem('borrador_plan_redox');
                
                mostrarNotificacion('Nuevo wizard iniciado', 'success');
            }
        }
        
        function volverDashboard() {
            if (confirm('¬øVolver al dashboard? Se perder√°n los datos actuales si no has guardado.')) {
                // Notificar al dashboard que se est√° cerrando
                notificarDashboard('generator-closing');
                
                // Si se abri√≥ desde el dashboard, cerrar ventana
                if (window.opener && !window.opener.closed) {
                    window.close();
                } else {
                    // Si se abri√≥ directamente, navegar al dashboard
                    window.location.href = 'dashboard-central.html';
                }
            }
        }
        
        // COMUNICACI√ìN CON DASHBOARD
        function notificarDashboard(tipo, datos = {}) {
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({
                        type: tipo,
                        data: datos,
                        source: 'generador-planes'
                    }, '*');
                }
                
                // Tambi√©n guardar en localStorage para sincronizaci√≥n
                const evento = {
                    type: tipo,
                    data: datos,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('ultimo_evento_redox', JSON.stringify(evento));
            } catch (error) {
                console.error('Error notificando dashboard:', error);
            }
        }
        
        // UTILIDADES
        function mostrarNotificacion(mensaje, tipo = 'info') {
            // Remover notificaci√≥n existente
            const existente = document.querySelector('.notification');
            if (existente) existente.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensaje;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // EVENT LISTENERS GLOBALES
        window.addEventListener('beforeunload', function() {
            if (currentStep > 1 && !wizardData.planGenerado) {
                guardarEstadoActual();
            }
            notificarDashboard('generator-closing');
        });
        
        // Atajos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (currentStep === 5 && wizardData.planGenerado) {
                    // No hacer nada si ya se gener√≥ el plan
                    return;
                }
                volverDashboard();
            }
            
            // Ctrl/Cmd + S para guardar borrador
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                guardarBorrador();
            }
            
            // Flecha derecha para siguiente paso
            if (e.key === 'ArrowRight' && !e.ctrlKey && !e.metaKey && currentStep < 5) {
                nextStep();
            }
            
            // Flecha izquierda para paso anterior
            if (e.key === 'ArrowLeft' && !e.ctrlKey && !e.metaKey && currentStep > 1) {
                previousStep();
            }
        });
        
        // Auto-guardar cada 30 segundos si hay cambios
        setInterval(() => {
            if (currentStep > 1 && wizardData.paciente) {
                guardarEstadoActual();
            }
        }, 30000);
        
        // Escuchar mensajes del dashboard
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'dashboard-closing') {
                // El dashboard se est√° cerrando, guardar estado
                guardarEstadoActual();
            }
        });
        
        console.log('Generador de Planes Redox cargado correctamente');
        console.log('Integraci√≥n con dashboard:', window.opener ? 'Disponible' : 'Ventana independiente');
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Planes - Sistema Redox</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-black: #1a1a1a;
            --secondary-black: #2d2d2d;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #666666;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --white: #ffffff;
            --border-light: #e8e8e8;
            --success-green: #27ae60;
            --error-red: #e74c3c;
            --warning-orange: #f39c12;
            --info-blue: #3498db;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-gray);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .connection-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .connection-indicator.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .connection-indicator.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .btn {
            padding: 12px 20px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: var(--white);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: var(--light-gray);
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary {
            background: var(--primary-black);
            color: var(--white);
            border-color: var(--primary-black);
        }
        
        .btn-primary:hover {
            background: var(--secondary-black);
        }
        
        .btn-success {
            background: var(--success-green);
            color: var(--white);
            border-color: var(--success-green);
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-secondary {
            background: var(--medium-gray);
            color: var(--text-primary);
            border-color: var(--medium-gray);
        }
        
        .wizard-container {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .wizard-steps {
            display: flex;
            background: var(--light-gray);
            border-bottom: 1px solid var(--border-light);
        }
        
        .step {
            flex: 1;
            padding: 20px;
            text-align: center;
            border-right: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .step:last-child {
            border-right: none;
        }
        
        .step.active {
            background: var(--primary-black);
            color: var(--white);
        }
        
        .step.completed {
            background: var(--success-green);
            color: var(--white);
        }
        
        .step-number {
            background: rgba(0,0,0,0.1);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255,255,255,0.2);
        }
        
        .step-content {
            padding: 40px;
            min-height: 600px;
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--info-blue);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: var(--white);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-black);
            box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .duration-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .duration-card {
            background: var(--white);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .duration-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .duration-card.selected {
            border-color: var(--primary-black);
            background: var(--light-gray);
        }
        
        .duration-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--info-blue);
            margin-bottom: 10px;
        }
        
        .duration-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .duration-description {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .condition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .condition-card {
            background: var(--white);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .condition-card:hover {
            border-color: var(--info-blue);
            transform: translateY(-2px);
        }
        
        .condition-card.selected {
            border-color: var(--primary-black);
            background: var(--light-gray);
        }
        
        .condition-icon {
            font-size: 32px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .condition-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .condition-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checkbox-item:hover {
            background: var(--light-gray);
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .plan-preview {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .wizard-actions {
            display: flex;
            justify-content: space-between;
            padding: 30px 40px;
            background: var(--light-gray);
            border-top: 1px solid var(--border-light);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--info-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .patient-info {
            background: var(--white);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .patient-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            max-width: 400px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .duration-cards,
            .condition-grid,
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
            
            .wizard-steps {
                flex-wrap: wrap;
            }
            
            .step {
                min-width: 120px;
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h1>Generador de Planes Redox</h1>
                <div id="connectionStatus" class="connection-indicator disconnected">
                    <span>‚óè</span> Conectando...
                </div>
            </div>
            <div class="header-actions">
                <a href="#" class="btn" onclick="volverDashboard()">‚Üê Dashboard</a>
                <button class="btn" onclick="guardarBorrador()" id="guardarBtn">üíæ Guardar Borrador</button>
                <button class="btn btn-primary" onclick="nuevoWizard()">üîÑ Nuevo Plan</button>
            </div>
        </div>
        
        <div class="wizard-container">
            <!-- Steps Header -->
            <div class="wizard-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div>Paciente</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div>Duraci√≥n</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div>Condiciones</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div>Configuraci√≥n</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div>Generar</div>
                </div>
            </div>
            
            <!-- STEP 1: Selecci√≥n de Paciente -->
            <div class="step-content active" data-step="1">
                <div class="form-section">
                    <h3>Seleccionar Paciente</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Elige el paciente para el cual quieres generar el plan personalizado:
                    </p>
                    <div class="form-group">
                        <label for="pacienteSelect">Paciente registrado:</label>
                        <select id="pacienteSelect">
                            <option value="">Cargando pacientes...</option>
                        </select>
                    </div>
                    
                    <div id="pacienteInfo" style="display: none;">
                        <div class="patient-info">
                            <h4>Informaci√≥n del Paciente</h4>
                            <div id="pacienteDetails" class="patient-details"></div>
                        </div>
                    </div>
                    
                    <div id="noPacientesMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 20px;">üë•</div>
                        <h3>No hay pacientes registrados</h3>
                        <p>Para generar un plan, primero debes registrar un paciente en el dashboard</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="volverDashboard()">
                            Ir al Dashboard
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- STEP 2: Duraci√≥n del Plan -->
            <div class="step-content" data-step="2">
                <div class="form-section">
                    <h3>Duraci√≥n del Tratamiento</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Selecciona la duraci√≥n total del plan nutricional bas√°ndote en la condici√≥n del paciente:
                    </p>
                    
                    <div class="duration-cards">
                        <div class="duration-card" data-duration="4">
                            <div class="duration-number">4</div>
                            <div class="duration-title">Plan Intensivo</div>
                            <div class="duration-description">
                                Resultados r√°pidos, m√°xima intensidad<br>
                                <strong>Ideal para:</strong> Casos urgentes
                            </div>
                        </div>
                        
                        <div class="duration-card" data-duration="8">
                            <div class="duration-number">8</div>
                            <div class="duration-title">Plan Est√°ndar</div>
                            <div class="duration-description">
                                Equilibrio ideal, sostenible<br>
                                <strong>Ideal para:</strong> Mayor√≠a de casos
                            </div>
                        </div>
                        
                        <div class="duration-card" data-duration="16">
                            <div class="duration-number">16</div>
                            <div class="duration-title">Plan Completo</div>
                            <div class="duration-description">
                                Transformaci√≥n profunda, 4 fases<br>
                                <strong>Ideal para:</strong> Casos complejos
                            </div>
                        </div>
                    </div>
                    
                    <div id="durationPreview" style="display: none;">
                        <div class="plan-preview">
                            <h4>Vista Previa de Fases:</h4>
                            <div id="phaseDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 3: Condiciones -->
            <div class="step-content" data-step="3">
                <div class="form-section">
                    <h3>Condici√≥n Principal</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Selecciona la condici√≥n principal que quieres tratar con este plan:
                    </p>
                    
                    <div class="condition-grid">
                        <div class="condition-card" data-condition="estre√±imiento">
                            <div class="condition-icon">üíß</div>
                            <div class="condition-name">Estre√±imiento Severo</div>
                            <div class="condition-description">
                                Protocolo laxante natural con hidrataci√≥n intensiva,
                                reparaci√≥n intestinal progresiva y terapias f√≠sicas espec√≠ficas
                            </div>
                        </div>
                        
                        <div class="condition-card" data-condition="sop">
                            <div class="condition-icon">‚öñÔ∏è</div>
                            <div class="condition-name">SOP (Ovario Poliqu√≠stico)</div>
                            <div class="condition-description">
                                Regulaci√≥n hormonal integral, antiandrog√©nicos naturales,
                                control insul√≠nico y modulaci√≥n inflamatoria
                            </div>
                        </div>
                        
                        <div class="condition-card" data-condition="perdida-peso">
                            <div class="condition-icon">üìâ</div>
                            <div class="condition-name">P√©rdida de Peso</div>
                            <div class="condition-description">
                                Termog√©nesis natural, control del apetito,
                                optimizaci√≥n de composici√≥n corporal sin efecto rebote
                            </div>
                        </div>
                        
                        <div class="condition-card" data-condition="inflamacion">
                            <div class="condition-icon">üî•</div>
                            <div class="condition-name">Inflamaci√≥n Sist√©mica</div>
                            <div class="condition-description">
                                Antiinflamatorios naturales potentes, antioxidantes espec√≠ficos
                                y reparaci√≥n celular integral
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Condiciones Secundarias</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Marca todas las condiciones adicionales que tambi√©n quieras abordar en el plan:
                    </p>
                    
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="sec-digestivo" value="problemas-digestivos">
                            <label for="sec-digestivo">Problemas Digestivos</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sec-fatiga" value="fatiga-cronica">
                            <label for="sec-fatiga">Fatiga Cr√≥nica</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sec-sue√±o" value="problemas-sue√±o">
                            <label for="sec-sue√±o">Problemas de Sue√±o</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sec-ansiedad" value="ansiedad-estres">
                            <label for="sec-ansiedad">Ansiedad/Estr√©s</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sec-piel" value="problemas-piel">
                            <label for="sec-piel">Problemas de Piel</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sec-cabello" value="caida-cabello">
                            <label for="sec-cabello">Ca√≠da del Cabello</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sec-articulares" value="dolor-articular">
                            <label for="sec-articulares">Dolores Articulares</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sec-circulacion" value="mala-circulacion">
                            <label for="sec-circulacion">Mala Circulaci√≥n</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 4: Configuraci√≥n -->
            <div class="step-